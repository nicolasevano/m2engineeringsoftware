<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://ws.apache.org/ns/synapse">
    <proxy name="conditionalArticleRedo" transports="http" startOnLoad="true" trace="enable" statistics="enable">
        <target>
            <inSequence>
                <send>
                    <endpoint>
                        <address uri="http://localhost:8280/services/articleConditionalService">
                            <timeout>
                                <duration>4000</duration>
                                <responseAction>fault</responseAction>
                            </timeout>
                            <suspendOnFailure>
                                <errorCodes>101404,101504</errorCodes>
                                <initialDuration>1000</initialDuration>
                                <progressionFactor>2.0</progressionFactor>
                                <maximumDuration>64000</maximumDuration>
                            </suspendOnFailure>
                            <markForSuspension>
                                <errorCodes>101404,101504</errorCodes>
                                <retriesBeforeSuspension>3</retriesBeforeSuspension>
                                <retryDelay>1</retryDelay>
                            </markForSuspension>
                        </address>
                    </endpoint>
                </send>
            </inSequence>
        </target>
        <publishWSDL uri="file:repository/resources/wsdl/serviceConditional.wsdl"/>
        <policy key="conf:/repository/axis2/service-groups/conditionalArticleRedo/services/conditionalArticleRedo/policies/WSO2CachingPolicy"/>
    </proxy>
    <proxy name="bookArticle" transports="https http" startOnLoad="true" trace="enable" statistics="enable">
        <target>
            <inSequence>
                <payloadFactory>
                    <format>
                        <ns2:getAllBook xmlns:ns2="http://referential_book.sodifrance.com/"/>
                    </format>
                </payloadFactory>
                <send>
                    <endpoint>
                        <address uri="http://localhost:8080/referential-book/services/1.0.0/BookWSImplPort/getAllBook"/>
                    </endpoint>
                </send>
            </inSequence>
            <outSequence>
                <xquery key="book-to-article.xq">
                    <variable name="payload" type="ELEMENT"/>
                </xquery>
                <send/>
            </outSequence>
        </target>
    </proxy>
    <localEntry key="book-to-article-conditional.xq">
        <x>
declare namespace ns2="http://referential_book.sodifrance.com/";
declare namespace soap="http://schemas.xmlsoap.org/soap/envelope/";
declare namespace soapenv="http://www.w3.org/2003/05/soap-envelope";
declare variable $payload as document-node() external;
&lt;getAllArticleConditionalResponse&gt;{for $book in $payload/ns2:getAllBookResponse/return return &lt;return&gt;
                &lt;author&gt;{$book/author/text()}&lt;/author&gt;
                &lt;kind&gt;book&lt;/kind&gt;
                &lt;editor&gt;{$book/editor/text()}&lt;/editor&gt;
                &lt;meta&gt;chapitre: {$book/NBChapitre/text()}; nb page: {$book/NBPage/text()}; description: {$book/description/text()}&lt;/meta&gt;
                &lt;title&gt;{$book/title/text()}&lt;/title&gt;
                &lt;publishDate&gt;{$book/publishDate/text()}&lt;/publishDate&gt;
                &lt;releaseDate&gt;{$book/releaseDate/text()}&lt;/releaseDate&gt;
&lt;/return&gt;}&lt;/getAllArticleConditionalResponse&gt;</x>
    </localEntry>
    <localEntry key="book-to-unic-article.xq">
        <x>
declare namespace ns2="http://referential_book.sodifrance.com/";
declare namespace soap="http://schemas.xmlsoap.org/soap/envelope/";
declare namespace soapenv="http://www.w3.org/2003/05/soap-envelope";
declare variable $payload as document-node() external;
&lt;getArticleConditionalResponse&gt;{for $book in $payload/ns2:getBookResponse/return return &lt;return&gt;
                &lt;author&gt;{$book/author/text()}&lt;/author&gt;
                &lt;kind&gt;book&lt;/kind&gt;
                &lt;editor&gt;{$book/editor/text()}&lt;/editor&gt;
                &lt;meta&gt;chapitre: {$book/NBChapitre/text()}; nb page: {$book/NBPage/text()}; description: {$book/description/text()}&lt;/meta&gt;
                &lt;title&gt;{$book/title/text()}&lt;/title&gt;
                &lt;publishDate&gt;{$book/publishDate/text()}&lt;/publishDate&gt;
                &lt;releaseDate&gt;{$book/releaseDate/text()}&lt;/releaseDate&gt;
&lt;/return&gt;}&lt;/getArticleConditionalResponse&gt;</x>
    </localEntry>
    <localEntry key="cd-to-unic-article.xq">
        <x>
	
declare namespace ns2="http://referential_cd.sodifrance.com/";
declare namespace soap="http://schemas.xmlsoap.org/soap/envelope/";
declare namespace soapenv="http://www.w3.org/2003/05/soap-envelope";
declare variable $payload as document-node() external;
&lt;getArticleConditionalResponse&gt;{for $cd in $payload/ns2:getCDResponse/return return &lt;return&gt;
						&lt;author&gt;{$cd/artist/text()}&lt;/author&gt;
						&lt;kind&gt;cd&lt;/kind&gt;
						&lt;editor&gt;{$cd/editor/text()}&lt;/editor&gt;
						&lt;meta&gt;number of track: {$cd/numberOfTrack/text()}&lt;/meta&gt;
						&lt;title&gt;{$cd/title/text()}&lt;/title&gt;
						&lt;publishDate&gt;{$cd/publishDate/text()}&lt;/publishDate&gt;
						&lt;releaseDate&gt;{$cd/releaseDate/text()}&lt;/releaseDate&gt;
					&lt;/return&gt;
}&lt;/getArticleConditionalResponse&gt;
	
        </x>
    </localEntry>
    <localEntry key="cd-to-article-conditional.xq">
        <x>
	
declare namespace ns2="http://referential_cd.sodifrance.com/";
declare namespace soap="http://schemas.xmlsoap.org/soap/envelope/";
declare namespace soapenv="http://www.w3.org/2003/05/soap-envelope";
declare variable $payload as document-node() external;
&lt;getAllArticleConditionalResponse&gt;{for $cd in $payload/ns2:getAllCDResponse/return return &lt;return&gt;
						&lt;author&gt;{$cd/artist/text()}&lt;/author&gt;
						&lt;kind&gt;cd&lt;/kind&gt;
						&lt;editor&gt;{$cd/editor/text()}&lt;/editor&gt;
						&lt;meta&gt;number of track: {$cd/numberOfTrack/text()}&lt;/meta&gt;
						&lt;title&gt;{$cd/title/text()}&lt;/title&gt;
						&lt;publishDate&gt;{$cd/publishDate/text()}&lt;/publishDate&gt;
						&lt;releaseDate&gt;{$cd/releaseDate/text()}&lt;/releaseDate&gt;
					&lt;/return&gt;
}&lt;/getAllArticleConditionalResponse&gt;
	
        </x>
    </localEntry>
</definitions>
